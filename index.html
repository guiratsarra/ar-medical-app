<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Medical Visualization on PC with Hand Gestures</title>
    <!-- Include A-Frame -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <!-- Include MediaPipe Hands -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
        }
        #controls select, #controls button {
            margin: 5px 0;
            display: block;
            width: 90%;
        }
        #video {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 320px;
            height: 240px;
            z-index: 1;
            transform: scaleX(-1); /* Miroir pour correspondre à la caméra */
        }
        a-scene {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }
    </style>
</head>
<body>
    <!-- Contrôles pour choisir les organes -->
    <div id="controls">
        <label for="organ-select">Choisir un organe :</label>
        <select id="organ-select">
            <option value="colon.glb">Colon</option>
            <option value="liver.glb">Foie</option>
            <option value="Segment_1.glb">Segment 1</option>
            <option value="aorta.glb">Aorte</option>
        </select>
        <button id="load-organ">Charger l'organe</button>
    </div>

    <!-- Scène A-Frame -->
    <a-scene embedded>
        <a-entity id="organ-model" gltf-model="url(colon.glb)" position="0 0 -2" scale="1 1 1" visible="false"></a-entity>
        <a-entity camera position="0 1.6 0"></a-entity>
    </a-scene>

    <!-- Vidéo pour la caméra -->
    <video id="video" autoplay playsinline></video>

    <script>
        // Initialisation de MediaPipe Hands
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({
            maxNumHands: 2,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        const camera = new Camera(document.getElementById('video'), {
            onFrame: async () => await hands.send({image: document.getElementById('video')}),
            width: 1280,
            height: 720
        });
        hands.onResults(onResults);
        camera.start();

        // Gestion des gestes
        let isLeftHandUp = false;
        let isRightHandUp = false;
        function onResults(results) {
            if (results.multiHandLandmarks) {
                for (const landmarks of results.multiHandLandmarks) {
                    const hand = results.multiHandedness.find(h => h.index === landmarks[0].visibility).label;
                    const indexFinger = landmarks[8]; // Pointe de l'index
                    const wrist = landmarks[0]; // Poignet
                    const distance = Math.hypot(indexFinger.x - wrist.x, indexFinger.y - wrist.y);
                    if (hand === 'Left' && indexFinger.y < wrist.y && distance > 0.1) isLeftHandUp = true;
                    if (hand === 'Right' && indexFinger.y < wrist.y && distance > 0.1) isRightHandUp = true;
                }
                // Si les deux mains sont levées, toggle la visibilité
                if (isLeftHandUp && isRightHandUp) {
                    const model = document.getElementById('organ-model');
                    model.setAttribute('visible', !model.getAttribute('visible'));
                    isLeftHandUp = false;
                    isRightHandUp = false;
                }
            }
        }

        // Charger l'organe sélectionné
        document.getElementById('load-organ').addEventListener('click', () => {
            const select = document.getElementById('organ-select');
            const modelUrl = select.value;
            const model = document.getElementById('organ-model');
            model.setAttribute('gltf-model', `url(${modelUrl})`);
            model.setAttribute('visible', false); // Caché jusqu'à ce que le geste soit détecté
        });
    </script>
</body>
</html>